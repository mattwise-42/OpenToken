name: Java Multi-Language Sync Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "lib/java/opentoken/src/main/java/com/truveta/opentoken/**/*.java"
      - "lib/python/opentoken/src/**/*.py"
      - "lib/nodejs/opentoken/src/**/*.js"
      - "lib/nodejs/opentoken/src/**/*.ts"

jobs:
  sync-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch full history for proper PR base comparison
          fetch-depth: 0

      - name: Setup toolchain (Python)
        uses: ./.github/actions/setup-toolchain
        with:
          enable-java: false
          enable-python: true
          python-version: "3.10"

      - name: Check Java multi-language sync
        id: sync-check
        run: |
          # Set up git remote for proper base branch comparison
          git remote set-url origin https://github.com/${{ github.repository }}
          git fetch origin ${{ github.event.pull_request.base.ref }}

          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          echo "Checking Java multi-language sync against: origin/$BASE_BRANCH"

          # Generate sync report checking that both Java and target language files were modified
          SYNC_REPORT=$(python3 tools/java_language_syncer.py \
            --format github-checklist \
            --check-both-modified \
            --since "origin/$BASE_BRANCH" 2>&1)
          SYNC_EXIT_CODE=$?

          echo "SYNC_REPORT<<EOF" >> $GITHUB_OUTPUT
          echo "$SYNC_REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "SYNC_EXIT_CODE=$SYNC_EXIT_CODE" >> $GITHUB_OUTPUT

          # Extract completion stats for quick reference
          if echo "$SYNC_REPORT" | grep -q "completed)"; then
            COMPLETION_STATUS=$(echo "$SYNC_REPORT" | grep -o "([0-9]*/[0-9]* completed)" | head -1)
            echo "COMPLETION_STATUS=$COMPLETION_STATUS" >> $GITHUB_OUTPUT
            
            # Extract numbers for progress calculation using sed for more reliable parsing
            COMPLETED=$(echo "$COMPLETION_STATUS" | sed -n 's/^(\([0-9]*\)\/\([0-9]*\) completed)$/\1/p')
            TOTAL=$(echo "$COMPLETION_STATUS" | sed -n 's/^(\([0-9]*\)\/\([0-9]*\) completed)$/\2/p')
            
            # Default to 0 and 1 if extraction fails
            COMPLETED=${COMPLETED:-0}
            TOTAL=${TOTAL:-1}
            
            echo "COMPLETED=$COMPLETED" >> $GITHUB_OUTPUT
            echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
            
            if [ "$COMPLETED" -eq "$TOTAL" ] && [ "$COMPLETED" -gt 0 ]; then
              echo "SYNC_COMPLETE=true" >> $GITHUB_OUTPUT
            else
              echo "SYNC_COMPLETE=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "COMPLETION_STATUS=All synced" >> $GITHUB_OUTPUT
            echo "SYNC_COMPLETE=true" >> $GITHUB_OUTPUT
          fi

          # Show summary in workflow log
          echo "Sync Status: $COMPLETION_STATUS"

          # Always exit 0 for workflow to continue to comment step
          exit 0

      - name: Create PR comment with progress tracking
        uses: actions/github-script@v7
        with:
          script: |
            const syncReport = ${{ toJSON(steps.sync-check.outputs.SYNC_REPORT) }};
            const completionStatus = `${{ steps.sync-check.outputs.COMPLETION_STATUS }}`;
            const isComplete = `${{ steps.sync-check.outputs.SYNC_COMPLETE }}` === 'true';
            const completed = `${{ steps.sync-check.outputs.COMPLETED }}` || '0';
            const total = `${{ steps.sync-check.outputs.TOTAL }}` || '0';

            let commentBody;

            if (isComplete || syncReport.includes('All Java changes appear to be in sync')) {
              let finalStatusLine = '';
              if (completed > 0) {
                finalStatusLine = `**Final Status**: ${completionStatus}`;
              }
              
              commentBody = `## ‚úÖ Java Multi-Language Sync Status: Complete!
              All Java changes in this PR have corresponding target language file modifications.
              ` + finalStatusLine;
            } else {            
              commentBody = `## üîÑ Java Multi-Language Sync Progress ${completionStatus}
              ${syncReport}
              ### üìã How to use this checklist:
              - **‚úÖ SYNCED** = Both Java and target language files modified in this PR ‚úÖ **COMPLETED**
              - **‚è≥ NEEDS SYNC** = Java modified but target language not updated yet ‚è≥ **PENDING** 
              - **‚ùå MISSING** = Target language file doesn't exist and needs to be created ‚è≥ **PENDING**
              
              ### Multi-commit workflow support:
              This sync tracker monitors your progress across **all commits in this PR**. When you modify the corresponding target language files, they'll automatically show as ‚úÖ SYNCED in subsequent workflow runs!
              **Next steps**: Modify the ‚è≥ pending target language files to complete the sync.`;
            }

            // Find and delete previous sync comments to keep history clean
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const syncComments = comments.data.filter(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('Java Multi-Language Sync') || comment.body.includes('Java-Python Sync') || comment.body.includes('Sync Status') || comment.body.includes('Sync Progress'))
            );

            // Delete all previous sync comments
            for (const comment of syncComments) {
              try {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
                console.log(`Deleted previous sync comment: ${comment.id}`);
              } catch (error) {
                console.log(`Problem deleting comment ${comment.id}: ${error.message}`);
              }
            }

            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
            console.log('Created new sync comment');

      - name: Fail workflow if sync is incomplete
        if: steps.sync-check.outputs.SYNC_COMPLETE != 'true'
        run: |
          echo "‚ùå Java multi-language sync is incomplete"
          echo "Status: ${{ steps.sync-check.outputs.COMPLETION_STATUS }}"
          echo "Completed: ${{ steps.sync-check.outputs.COMPLETED }}/${{ steps.sync-check.outputs.TOTAL }}"
          echo ""
          echo "Please update the corresponding target language files before merging."
          echo "Check the PR comment for detailed sync requirements."
          exit 1
