# This workflow will build a package using Maven and then publish it to GitHub packages on pushes to main
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read

    steps:
      - uses: actions/checkout@v4
      
      - name: Get version from .bumpversion.cfg
        id: get_version
        run: |
          # Get version from .bumpversion.cfg
          VERSION=$(sed -n '/^\[bumpversion\]/,/^\[/p' .bumpversion.cfg | grep "^current_version" | cut -d'=' -f2 | tr -d ' ')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected version: ${VERSION}"
          echo "Detected tag: v${VERSION}"
      
      - name: Find matching release
        id: find_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'v${{ steps.get_version.outputs.version }}';
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
              core.setOutput('release_id', release.data.id);
              core.setOutput('found', 'true');
              console.log(`Found release ${tag} with ID ${release.data.id}`);
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('found', 'false');
                console.log(`No release found for tag ${tag}`);
              } else {
                throw error;
              }
            }
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
          settings-path: ${{ github.workspace }} # location for the settings.xml file

      - name: Build with Maven
        run: cd lib/java && mvn -B package --file pom.xml

      # Change run command to only run lib/java, this is temporary
      - name: Publish to GitHub Packages Apache Maven
        run: cd lib/java && mvn deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload Maven artifacts to release
        if: steps.find_release.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const artifactDir = 'lib/java/target';
            const releaseId = '${{ steps.find_release.outputs.release_id }}';

            if (!releaseId) {
              console.log('No release ID found, skipping artifact upload');
              return;
            }

            if (!fs.existsSync(artifactDir)) {
              console.log('No artifacts directory found');
              return;
            }

            const files = fs.readdirSync(artifactDir).filter(f => 
              (f.endsWith('.jar') || f.endsWith('.pom')) && !f.endsWith('javadoc.jar') && !f.endsWith('sources.jar')
            );

            for (const file of files) {
              const filePath = path.join(artifactDir, file);
              const data = fs.readFileSync(filePath);

              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: releaseId,
                name: file,
                data: data
              });
              console.log(`Uploaded ${file} to release ${{ steps.get_version.outputs.tag }}`);
            }
