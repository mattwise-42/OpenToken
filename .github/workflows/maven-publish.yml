# This workflow will build a package using Maven and then publish it to GitHub packages on pushes to main
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_id:
        description: 'Release ID to attach artifacts to'
        required: false
        type: string
      release_tag:
        description: 'Release tag'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
          settings-path: ${{ github.workspace }} # location for the settings.xml file

      - name: Build with Maven
        run: cd lib/java && mvn -B package --file pom.xml

      # Change run command to only run lib/java, this is temporary
      - name: Publish to GitHub Packages Apache Maven
        run: cd lib/java && mvn deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload Maven artifacts to release
        if: inputs.release_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const artifactDir = 'lib/java/target';
            const releaseId = '${{ inputs.release_id }}';

            if (!releaseId) {
              console.log('No release ID provided, skipping artifact upload');
              return;
            }

            if (!fs.existsSync(artifactDir)) {
              console.log('No artifacts directory found');
              return;
            }

            const files = fs.readdirSync(artifactDir).filter(f => 
              (f.endsWith('.jar') || f.endsWith('.pom')) && !f.endsWith('javadoc.jar') && !f.endsWith('sources.jar')
            );

            for (const file of files) {
              const filePath = path.join(artifactDir, file);
              const data = fs.readFileSync(filePath);

              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: releaseId,
                name: file,
                data: data
              });
              console.log(`Uploaded ${file}`);
            }
