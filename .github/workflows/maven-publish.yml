# This workflow will build a package using Maven and then publish it to GitHub packages on pushes to main
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  release:
    types: [created, published]
  workflow_run:
    workflows: ["Create Release on Merge"]
    types: [completed]

# Minimal global token permissions; jobs may elevate as needed
permissions:
  contents: read

jobs:
  release-info:
    uses: ./.github/workflows/release-context.yml
    secrets: inherit
    with:
      lookup-release: true

  build:
    needs: release-info
    # Only run on successful release workflow runs; otherwise always run
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    env:
      VERSION: ${{ needs.release-info.outputs['version'] }}
      TAG: ${{ needs.release-info.outputs['tag'] }}
      RELEASE_FOUND: ${{ needs.release-info.outputs['release-found'] }}
      RELEASE_ID: ${{ needs.release-info.outputs['release-id'] }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup toolchain (Java)
        uses: ./.github/actions/setup-toolchain
        with:
          enable-python: false

      - name: Build with Maven
        run: cd lib/java/opentoken && mvn -B package --file pom.xml

      # Change run command to only run lib/java/opentoken, this is temporary
      - name: Publish to GitHub Packages Apache Maven
        run: cd lib/java/opentoken && mvn deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload Maven artifacts to release
        if: env.RELEASE_FOUND == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const tag = '${{ env.TAG }}';
            const artifactDir = 'lib/java/opentoken/target';

            console.log(`[DEBUG] Starting artifact upload process`);
            console.log(`[DEBUG] Tag: ${tag}`);
            console.log(`[DEBUG] Artifact directory: ${artifactDir}`);
            console.log(`[DEBUG] Artifact directory exists: ${fs.existsSync(artifactDir)}`);

            if (!fs.existsSync(artifactDir)) {
              console.log(`✗ No artifacts directory found at ${artifactDir}`);
              return;
            }

            // Get or find the release
            let releaseId = '${{ env.RELEASE_ID }}';
            console.log(`[DEBUG] Initial releaseId from find_release step: ${releaseId}`);

            if (!releaseId) {
              console.log(`[DEBUG] releaseId is empty, querying GitHub for release ${tag}`);
              try {
                const release = await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tag
                });
                releaseId = release.data.id;
                console.log(`[DEBUG] Found release on second query with ID ${releaseId}`);
              } catch (error) {
                console.log(`✗ No release found for tag ${tag}`);
                console.log(`[DEBUG] Error: ${error.message}`);
                return;
              }
            }

            const files = fs.readdirSync(artifactDir).filter(f => 
              (f.endsWith('.jar') || f.endsWith('.pom')) && !f.endsWith('javadoc.jar') && !f.endsWith('sources.jar') && !f.startsWith('original-')
            );

            console.log(`[DEBUG] Found ${files.length} artifacts to upload:`);
            files.forEach(f => console.log(`  - ${f}`));

            if (files.length === 0) {
              console.log(`✗ No artifacts found to upload`);
              return;
            }

            console.log(`[DEBUG] Uploading to release ID: ${releaseId}`);
            for (const file of files) {
              try {
                const filePath = path.join(artifactDir, file);
                const fileSize = fs.statSync(filePath).size;
                console.log(`[DEBUG] Uploading ${file} (${fileSize} bytes)...`);

                const response = await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: file,
                  data: fs.readFileSync(filePath)
                });
                console.log(`✓ Successfully uploaded ${file}`);
                console.log(`[DEBUG] Asset ID: ${response.data.id}`);
              } catch (error) {
                console.log(`✗ Error uploading ${file}: ${error.message}`);
                if (error.status) {
                  console.log(`[DEBUG] HTTP Status: ${error.status}`);
                }
              }
            }
            console.log(`[DEBUG] Artifact upload process complete`);
