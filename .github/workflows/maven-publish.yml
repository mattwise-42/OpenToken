# This workflow will build a package using Maven and then publish it to GitHub packages on pushes to main
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: Maven Package

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: read

    steps:
      - uses: actions/checkout@v4

      - name: Get version from .bumpversion.cfg
        id: get_version
        run: |
          # Get version from .bumpversion.cfg
          VERSION=$(sed -n '/^\[bumpversion\]/,/^\[/p' .bumpversion.cfg | grep "^current_version" | cut -d'=' -f2 | tr -d ' ')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Detected version: ${VERSION}"
          echo "Detected tag: v${VERSION}"

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "temurin"
          server-id: github # Value of the distributionManagement/repository/id field of the pom.xml
          settings-path: ${{ github.workspace }} # location for the settings.xml file

      - name: Build with Maven
        run: cd lib/java && mvn -B package --file pom.xml -DskipTests

      # Change run command to only run lib/java, this is temporary
      - name: Publish to GitHub Packages Apache Maven
        run: cd lib/java && mvn deploy -s $GITHUB_WORKSPACE/settings.xml
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Find matching release
        id: find_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'v${{ steps.get_version.outputs.version }}';
            console.log(`[DEBUG] Looking for release with tag: ${tag}`);
            console.log(`[DEBUG] Repository: ${context.repo.owner}/${context.repo.repo}`);

            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
              console.log(`[DEBUG] Found release for tag ${tag}`);
              console.log(`[DEBUG] Release ID: ${release.data.id}`);
              console.log(`[DEBUG] Release name: ${release.data.name}`);
              console.log(`[DEBUG] Release URL: ${release.data.html_url}`);
              core.setOutput('release_id', release.data.id);
              core.setOutput('found', 'true');
              console.log(`✓ Found release ${tag} with ID ${release.data.id}`);
            } catch (error) {
              console.log(`[DEBUG] Error status: ${error.status}`);
              console.log(`[DEBUG] Error message: ${error.message}`);
              if (error.status === 404) {
                core.setOutput('found', 'false');
                console.log(`✗ No release found for tag ${tag}`);
              } else {
                throw error;
              }
            }

      - name: Upload Maven artifacts to release
        if: steps.find_release.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const tag = 'v${{ steps.get_version.outputs.version }}';
            const artifactDir = 'lib/java/target';

            console.log(`[DEBUG] Starting artifact upload process`);
            console.log(`[DEBUG] Tag: ${tag}`);
            console.log(`[DEBUG] Artifact directory: ${artifactDir}`);
            console.log(`[DEBUG] Artifact directory exists: ${fs.existsSync(artifactDir)}`);

            if (!fs.existsSync(artifactDir)) {
              console.log(`✗ No artifacts directory found at ${artifactDir}`);
              return;
            }

            // Get or find the release
            let releaseId = '${{ steps.find_release.outputs.release_id }}';
            console.log(`[DEBUG] Initial releaseId from find_release step: ${releaseId}`);

            if (!releaseId) {
              console.log(`[DEBUG] releaseId is empty, querying GitHub for release ${tag}`);
              try {
                const release = await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tag
                });
                releaseId = release.data.id;
                console.log(`[DEBUG] Found release on second query with ID ${releaseId}`);
              } catch (error) {
                console.log(`✗ No release found for tag ${tag}`);
                console.log(`[DEBUG] Error: ${error.message}`);
                return;
              }
            }

            const files = fs.readdirSync(artifactDir).filter(f => 
              (f.endsWith('.jar') || f.endsWith('.pom')) && !f.endsWith('javadoc.jar') && !f.endsWith('sources.jar') && !f.startsWith('original-')
            );

            console.log(`[DEBUG] Found ${files.length} artifacts to upload:`);
            files.forEach(f => console.log(`  - ${f}`));

            if (files.length === 0) {
              console.log(`✗ No artifacts found to upload`);
              return;
            }

            console.log(`[DEBUG] Uploading to release ID: ${releaseId}`);
            for (const file of files) {
              try {
                const filePath = path.join(artifactDir, file);
                const fileSize = fs.statSync(filePath).size;
                console.log(`[DEBUG] Uploading ${file} (${fileSize} bytes)...`);

                const response = await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: file,
                  data: fs.readFileSync(filePath)
                });
                console.log(`✓ Successfully uploaded ${file}`);
                console.log(`[DEBUG] Asset ID: ${response.data.id}`);
              } catch (error) {
                console.log(`✗ Error uploading ${file}: ${error.message}`);
                if (error.status) {
                  console.log(`[DEBUG] HTTP Status: ${error.status}`);
                }
              }
            }
            console.log(`[DEBUG] Artifact upload process complete`);
