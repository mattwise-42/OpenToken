name: Create Release on Merge

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    # Run only if PR was merged from release branch
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          set -euo pipefail

          # Get version from .bumpversion.cfg - only the [bumpversion] section
          VERSION=$(sed -n '/^\[bumpversion\]/,/^\[/p' .bumpversion.cfg | grep "^current_version" | cut -d'=' -f2 | tr -d ' ')

          # sanitize against characters that will break GITHUB_OUTPUT (angle brackets, CRs, newlines)
          SAFE_VERSION=$(printf '%s' "$VERSION" | tr -d '<>' | tr -d $'\r' | tr -d $'\n')
          if [ -z "$SAFE_VERSION" ]; then
            echo "Failed to determine a valid version from .bumpversion.cfg" >&2
            exit 1
          fi
          echo "version=${SAFE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${SAFE_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Version: ${SAFE_VERSION}"
          echo "Tag: v${SAFE_VERSION}"

      - name: Check if tag exists
        id: check_tag
        run: |
          TAG="v${{ steps.get_version.outputs.version }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag $TAG does not exist"
          fi

      - name: Check if release exists
        id: check_release
        if: steps.check_tag.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const tag = 'v${{ steps.get_version.outputs.version }}';
            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tag
              });
              core.setOutput('exists', 'true');
              console.log(`Release ${tag} already exists`);
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
                console.log(`Release ${tag} does not exist`);
              } else {
                throw error;
              }
            }

      - name: Create GitHub Release
        id: create_release
        if: steps.check_tag.outputs.exists == 'false' && steps.check_release.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.get_version.outputs.version }}';
            const tag = 'v' + version;

            // Get the commit SHA
            const sha = context.sha;

            // Create the tag
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/${tag}`,
                sha: sha
              });
              console.log(`Created tag ${tag}`);
            } catch (error) {
              console.log(`Tag creation error: ${error.message}`);
              // Tag might already exist, continue anyway
            }

            // Generate release notes
            let releaseNotes = '';
            try {
              const notes = await github.rest.repos.generateReleaseNotes({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag
              });
              releaseNotes = notes.data.body;
            } catch (error) {
              console.log(`Could not generate release notes: ${error.message}`);
              releaseNotes = `Release ${version}`;
            }

            // Create the release
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: tag,
              body: releaseNotes,
              draft: false,
              prerelease: false
            });

            console.log(`Created release: ${release.data.html_url}`);
            core.setOutput('release_url', release.data.html_url);
            core.setOutput('release_id', release.data.id);

      - name: Merge main back to develop
        if: steps.check_tag.outputs.exists == 'false' && steps.check_release.outputs.exists == 'false'
        run: |
          set -e

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if develop branch exists
          if ! git ls-remote --heads origin develop | grep -q develop; then
            echo "Develop branch does not exist yet, skipping merge back"
            exit 0
          fi

          # Fetch and checkout develop
          git fetch origin develop
          git checkout develop

          # Merge main into develop
          echo "Merging main into develop..."
          if git merge origin/main --no-edit -m "chore: sync main back to develop after release ${{ steps.get_version.outputs.version }}"; then
            echo "‚úÖ Successfully merged main into develop"
            
            # Push the merge
            git push origin develop
            echo "‚úÖ Pushed merge to develop"
          else
            echo "‚ö†Ô∏è  Merge conflict detected. Creating issue for manual resolution..."
            git merge --abort || true
            
            # Note: Creating issue requires github-script or gh CLI
            # For now, just log the conflict
            echo "‚ö†Ô∏è  Manual merge required from main to develop"
            exit 0
          fi

      - name: Summary
        if: steps.check_tag.outputs.exists == 'false' && steps.check_release.outputs.exists == 'false'
        run: |
          echo "‚úÖ Release v${{ steps.get_version.outputs.version }} created successfully!"
          echo "üîñ Tag: v${{ steps.get_version.outputs.version }}"
          echo "üì¶ Maven and Docker publish workflows will automatically attach artifacts to this release"
